name: Build ECH-enabled curl (Static with c-ares)

on:
  workflow_dispatch: # 手动触发构建

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用 22.04 以确保更好的 glibc 兼容性

    steps:
      - name: Checkout curl
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          path: curl

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool make gcc perl zlib1g-dev

# 第一步：手动构建静态 c-ares (使用 CMake)
      - name: Build static c-ares
        run: |
          git clone https://github.com/c-ares/c-ares.git
          cd c-ares
          mkdir build
          cd build
          # -DCARES_SHARED=OFF 确保只生成静态库
          # -DCARES_STATIC=ON 开启静态库构建
          # -DCARES_BUILD_TESTS=OFF 避免因为缺少 gtest 报错
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/cares-static \
                -DCARES_SHARED=OFF \
                -DCARES_STATIC=ON \
                -DCARES_BUILD_TESTS=OFF \
                -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          make install

      # 第二步：构建支持 ECH 的 OpenSSL (静态)
      - name: Build ECH-enabled OpenSSL
        run: |
          git clone https://github.com/openssl/openssl --branch feature/ech --single-branch
          cd openssl
          ./config no-shared --libdir=lib --prefix=$HOME/openssl-ech
          make -j$(nproc)
          make install_sw
          
      # 第三步：构建 curl，链接静态 OpenSSL 和 静态 c-ares
      - name: Build curl with ECH & c-ares
        run: |
          cd curl
          autoreconf -fi
          ./configure \
            --with-ssl=$HOME/openssl-ech \
            --enable-ares=$HOME/cares-static \
            --enable-ech \
            --enable-httpsrr \
            --enable-doh \
            --disable-shared \
            --enable-static \
            --without-libpsl \
            --without-libidn2 \
            --with-zlib
          make -j$(nproc)

      # 第四步：验证构建结果
      - name: Verify Build Features
        run: |
          echo "--- CURL VERSION INFO ---"
          ./curl/src/curl --version
          echo "--- CHECKING ECH, HTTPS-RR, AsynchDNS ---"
          ./curl/src/curl --version | grep -E "ECH|HTTPS-RR|AsynchDNS"
          
      # 第五步：验证链接情况 (确认是否还有动态依赖)
      - name: Verify Binary Linkage
        run: |
          echo "--- FILE INFO ---"
          file ./curl/src/curl
          echo "--- LDD INFO ---"
          ldd ./curl/src/curl || echo "Pure static binary"

      # 第六步：上传单个静态二进制文件
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-ech-ares-static-linux
          path: curl/src/curl
