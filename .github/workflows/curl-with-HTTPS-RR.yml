name: Build ECH-enabled curl

on:
#  push:
  workflow_dispatch: # on button click

jobs:
  build:
    runs-on: ubuntu-22.04  # 从 ubuntu-latest 改为 22.04

    steps:
      - name: Checkout curl
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          path: curl

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool make gcc perl zlib1g-dev

      # 第一步：构建支持 ECH 的 OpenSSL
      - name: Build ECH-enabled OpenSSL
        run: |
          git clone https://github.com/openssl/openssl --branch feature/ech --single-branch
          cd openssl
          ./config no-shared --libdir=lib --prefix=$HOME/openssl-ech
          make -j$(nproc)
          make install_sw
          
      # 第二步：构建 curl 并链接到上面的 OpenSSL
      - name: Build curl with ECH support
        run: |
          cd curl
          autoreconf -fi
           # 移除 LDFLAGS 中的 -rpath（因为我们要静态链接，不需要运行时路径）
           # 使用 LIBS 强制链接一些可能需要的底层库
          ./configure \
          --with-ssl=$HOME/openssl-ech \
          --enable-ech \
          --enable-httpsrr \
          --enable-doh \
          --disable-shared \
          --enable-static \
          --without-libpsl \
          --without-libidn2 \
          --with-zlib
          make -j$(nproc) P_CSIDL_PROGRAMS=  # 有时 make 会尝试重新链接，确保干净
          
      # 第三步：验证构建结果
      - name: Verify Build
        run: |
          ./curl/src/curl --version
          # 检查输出中是否包含 ECH 关键字
          ./curl/src/curl --version | grep -i "ECH" || echo "ECH support not found"

      - name: Build and Install curl
        run: |
          cd curl
          # ... 前面的 autoreconf 和 configure 命令保持不变 ...
          make -j$(nproc)
          # 将 curl 安装到当前目录下的 'dist' 文件夹
          make install DESTDIR=$(pwd)/dist

      - name: Verify correct binary
        run: |
          # 检查我们刚刚安装出来的文件版本
          ./curl/dist/usr/local/bin/curl --version | grep -i "ECH"

      - name: Verify Binary Linkage
        run: |
          file ./curl/src/curl
          ldd ./curl/src/curl || echo "No dependencies (Static)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-ech-static
          path: curl/src/curl  # 仅此一个文件，因为所有依赖都已打入内部
