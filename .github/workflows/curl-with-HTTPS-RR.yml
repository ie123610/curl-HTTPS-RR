name: Build ECH-enabled curl

on:
#  push:
  workflow_dispatch: # on button click

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout curl
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          path: curl

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool make gcc perl zlib1g-dev

      # 第一步：构建支持 ECH 的 OpenSSL
      - name: Build ECH-enabled OpenSSL
        run: |
          git clone https://github.com/openssl/openssl --branch feature/ech --single-branch
          cd openssl
          ./config --libdir=lib --prefix=$HOME/openssl-ech
          make -j$(nproc)
          make install_sw
          
      # 第二步：构建 curl 并链接到上面的 OpenSSL
      - name: Build curl with ECH support
        run: |
              cd curl
              autoreconf -fi  # 替代 ./buildconf
              export LDFLAGS="-Wl,-rpath,$HOME/openssl-ech/lib"
              ./configure \
                --with-ssl=$HOME/openssl-ech \
                --enable-ech \
                --enable-httpsrr \
                --enable-doh \
                --disable-shared \
                --without-libpsl \
                --enable-static \
                --without-libidn2
              make -j$(nproc)
          
      # 第三步：验证构建结果
      - name: Verify Build
        run: |
          ./curl/src/curl --version
          # 检查输出中是否包含 ECH 关键字
          ./curl/src/curl --version | grep -i "ECH" || echo "ECH support not found"

      - name: Build and Install curl
        run: |
          cd curl
          # ... 前面的 autoreconf 和 configure 命令保持不变 ...
          make -j$(nproc)
          # 将 curl 安装到当前目录下的 'dist' 文件夹
          make install DESTDIR=$(pwd)/dist

      - name: Verify correct binary
        run: |
          # 检查我们刚刚安装出来的文件版本
          ./curl/dist/usr/local/bin/curl --version | grep -i "ECH"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-ech-bundle
          # 上传整个安装后的目录
          path: curl/dist/usr/local/
