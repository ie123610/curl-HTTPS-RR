name: Build ECH + HTTP3 + c-ares curl

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout curl
        uses: actions/checkout@v4
        with:
          repository: curl/curl
          path: curl

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y automake libtool make gcc perl zlib1g-dev cmake pkg-config

      # 1. 编译静态 c-ares
      - name: Build static c-ares
        run: |
          git clone https://github.com/c-ares/c-ares.git
          cd c-ares
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/all-static \
                -DCARES_SHARED=OFF -DCARES_STATIC=ON -DCARES_BUILD_TESTS=OFF ..
          make -j$(nproc) install

      # 2. 编译静态 OpenSSL (ECH 分支)
      - name: Build ECH-enabled OpenSSL
        run: |
          git clone https://github.com/openssl/openssl --branch feature/ech --single-branch
          cd openssl
          ./config no-shared --libdir=lib --prefix=$HOME/all-static
          make -j$(nproc)
          make install_sw

      # 3. 编译静态 nghttp3 (HTTP/3 帧处理库)
      - name: Build nghttp3
        run: |
          git clone https://github.com/ngtcp2/nghttp3.git --recursive
          cd nghttp3
          autoreconf -fi
          ./configure --prefix=$HOME/all-static --enable-lib-only --enable-static --disable-shared
          make -j$(nproc) install

      # 4. 编译静态 ngtcp2 (QUIC 协议库)
      - name: Build ngtcp2
        run: |
          git clone https://github.com/ngtcp2/ngtcp2.git --recursive
          cd ngtcp2
          autoreconf -fi
          # 指定 openssl 路径以开启 QUIC 支持
          ./configure --prefix=$HOME/all-static \
                      --with-openssl \
                      PKG_CONFIG_PATH="$HOME/all-static/lib/pkgconfig" \
                      --enable-static --disable-shared
          make -j$(nproc) install

      # 5. 最终编译 curl
      - name: Build curl with ECH, c-ares, HTTP3
        run: |
          cd curl
          autoreconf -fi
          # 设置 pkg-config 路径以便发现所有自定义库
          export PKG_CONFIG_PATH="$HOME/all-static/lib/pkgconfig"
          ./configure \
            --with-ssl=$HOME/all-static \
            --enable-ares=$HOME/all-static \
            --with-ngtcp2=$HOME/all-static \
            --with-nghttp3=$HOME/all-static \
            --enable-ech \
            --enable-httpsrr \
            --enable-doh \
            --disable-shared \
            --enable-static \
            --without-libpsl \
            --without-libidn2 \
            --with-zlib
          make -j$(nproc)

      # 6. 验证构建结果
      - name: Verify Build
        run: |
          echo "--- VERSION ---"
          ./curl/src/curl --version
          echo "--- CHECK FEATURES ---"
          ./curl/src/curl --version | grep -E "ECH|HTTP3|AsynchDNS|HTTPS-RR"
          echo "--- LDD CHECK ---"
          ldd ./curl/src/curl || echo "Static"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: curl-ech-h3-ares-static
          path: curl/src/curl
